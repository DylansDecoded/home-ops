version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: ENC[AES256_GCM,data:i3S1wQjeQXVt8ZPSnJKS+EAllLhZhWs=,iv:zjX70EaQlTLnE1b7PkwMzIOSpjojjzYYie4L4Ab97ok=,tag:pL3n23YA9oqv0g8acZqTuA==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:yviOsdITNXUTJqFrEr+OFK6dAZ9IGRDdgyuWjrCH02v7LeHAGDpLElUECBeqek/rnSD3XWqQm3LFGpBaJdyLHndfNIEseNon8grxyl/rz4NaJWGJ2iP/43gv3VutU10gUDbmFCAVvtt8raQDPgZrmIISKJfnab1yeTdW5JSok8lxROK1KbDGrDPDblyMP77DLdwApv81F5HgoFpcxpQ6F6LuHXB0+ZrWJnUb6Akxt1FXa8cMduK0M1KgEdDD3h0k1k+D03ilDrAy+VskT7qo1FZFWqX+GackVc92p9H2pYr7qsU+Fp89n6rH1rBgpLlR125MwDQk/FTxvOpO0CJYLRwQ/zTv4TvgCCV/xw+2m44KPS0mHMdvF/T7kETuQZO3ceW6ugwq6exXIq/nf2evfUBD5FrdksEVuLMmBaejUTP8QSdtBbTxEyXDVxJLtfQgzRgDtyoV8kpX7jx3KGaOjI6IW5AHPFuOHLKi4OkfN0b/IOk+kg3EMtMjDnpwiwod107YaKE3guPauDyKni2RCNQXl+CeB4xMt/CtW7e1JD05kWMqVUldUwlqh7//QKOaQd36W9bIi5Tzau7jFVwONtLXZx8I9ei8yWCi4dzQp1otMNd/H62Eq4st1vK/C8VuFCPlq+wwmhjFOWI6vdKUR7Qo1nTQEVheKVXP0vM12WwjwjRS6jKMKP/39tnTeqGl3lelPyBA6kNQ0mn8IApvL6/FAYkNlnC8+/+P6m+2tPim6ETotoSoo1EMjdieGpWYQqY801Om+PzRLhjEAKge0jLEi9Oo+v1ySxfLTXsknWjR08pflJjriH2fYh8iuULIiKR+Hw8DcRCKeEGlYeJ3OWnh1TddSFSrKGpzjIZcstfkC7yT,iv:mtgwDhLKbk77Wlg3utR0D8T2+gZ5FahXKm64pFCZJgs=,tag:i+I/cv5vG1nM6UEP2DwGxA==,type:str]
    key: ""
  certSANs:
    - 10.1.20.120
    - 127.0.0.1
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.32.2
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    extraConfig:
      maxPods: 150
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.1.20.0/24
    disableManifestsDirectory: true
  network:
    hostname: k8s-3
    interfaces:
      - deviceSelector:
          hardwareAddr: ac:e2:d3:10:d8:25
        mtu: 1500
        dhcp: true
        vlans:
          - vlanId: 40
            mtu: 1500
            dhcp: true
    disableSearchDomain: true
  time:
    servers:
      - 10.1.20.1
  install:
    disk: /dev/nvme0n1
    extraKernelArgs:
      - net.iframes=0
      # Less security, faster puter
      - apparmor=0
      # Less security, faster puter
      - init_on_alloc=0
      # Less security, faster puter
      - init_on_free=0
      # PCI Passthrough
      - intel_iommu=on
      # PCI Passthrough
      - iommu=pt
      # Less security, faster puter
      - mitigations=off
      # Less security, faster puter
      - security=none
      # Less security, faster puter
      - talos.auditd.disabled=1
    wipe: false
    image: factory.talos.dev/installer/1be6923a14b1498bc2930c02b286cbf9d98764032fb6a8659b8fce7c1476262b:v1.9.4
  files:
    # Spegel
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 420
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
  sysctls:
    # Watchdog
    fs.inotify.max_user_watches: 1048576
    # Watchdog
    fs.inotify.max_user_instances: 8192
    # 10Gb/s
    net.core.default_qdisc: fq
    # 10Gb/s | Cloudflared / QUIC
    net.core.rmem_max: 67108864
    # 10Gb/s | Cloudflared / QUIC
    net.core.wmem_max: 67108864
    # 10Gb/s
    net.ipv4.tcp_congestion_control: bbr
    # Send and accept data in the opening SYN packet
    net.ipv4.tcp_fastopen: 3
    # 10Gb/s | Jumbo frames
    net.ipv4.tcp_mtu_probing: 1
    # 10Gb/s
    net.ipv4.tcp_rmem: 4096 87380 33554432
    # 10Gb/s
    net.ipv4.tcp_wmem: 4096 65536 33554432
    # 10Gb/s
    net.ipv4.tcp_window_scaling: 1
    # PostgreSQL
    vm.nr_hugepages: 1024
  sysfs:
    devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
  features:
    rbac: true
    stableHostname: true
    # kubernetesTalosAPIAccess:
    #   enabled: true
    #   allowedRoles: ["os:admin"]
    #   allowedKubernetesNamespaces: ["actions-runner-system", "system-upgrade"]
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      resolveMemberNames: true
      forwardKubeDNSToHost: false
  udev:
    rules:
      # Thunderbolt
      - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"
      # Coral TPU
      - SUBSYSTEM=="apex", KERNEL=="apex*", GROUP="44", MODE="0660"
      # Intel GPU
      - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
  # kernel:
  #   modules:
  #     - name: nbd
  #     - name: thunderbolt
  #     - name: thunderbolt_net
  nodeLabels:
    intel.feature.node.kubernetes.io/gpu: "true"
    topology.kubernetes.io/region: main
    topology.kubernetes.io/zone: w
cluster:
  id: ENC[AES256_GCM,data:5zb75v5p91cvU4YKtcSyCsaaR55ZLvGRNbgyZvdyDvC1MiWzmFviI7K9V/8=,iv:aEpsJqRNtCSDsuRunfMppez6UhMfos/6kCbG4YEN9ng=,tag:PaYCVxhcx5BPwj2yxTRx+g==,type:str]
  secret: ENC[AES256_GCM,data:cW+B9khyGdfDB6LC+EfJMIeTItc62aoG3tgo3B2lmK5K7pxTUwTfZ9xZ4Ws=,iv:dHBpwBS6kxRfIHybseIr3aVFUbVOOkR8T7G/84AQKHw=,tag:v47qg4cdolmLU7+isPe2UA==,type:str]
  controlPlane:
    endpoint: https://10.1.20.120:6443
  clusterName: main
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
  coreDNS:
    disabled: true
  extraManifests:
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagerconfigs.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagers.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_probes.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheusagents.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheusrules.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_scrapeconfigs.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_thanosrulers.yaml
  token: ENC[AES256_GCM,data:7F2rFsH5OuHOGhGEz1g7JiKyg3TbNa4=,iv:XYa+wxiqWNZeXhq3rQIbPNNrCTEtaCXFTuHd7EcRUbQ=,tag:hImPLO0pqh0VkETAHwFX3Q==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:EsEGzpnYKqJK3gzwxDRlR2D1cq89XAH0vmFQIWE6UnE63ghHuJrxznijn9pwe9iP8Ams6Tscvwktm+OJ+WlyypijBtYtRaZTOtD7Kr8Y63W3BUiGuef4E0UgFmRPOBpeUfIWZhlVoPXX47hd3R3CAXxxQrHKv38XzXKa8JRlJ2V8+5vHqdF0t9e6fjFW52aLURx3ZI2YAcTXJZedJAugIFHdoE2WRH1ITc2XPIPvLEqTSCbju+mUv0PBmXtibMaQWppQrI2xeHpoOgGbcY7PBc1RHSE5p0b91zPehZW4vITXbFYBg8HheFY2dMQn6EeQbKiYYvbCctm1Yi/G0ZwNkelarFDOZlIwLLMhGyVDytAezZYb7aSwf3ayGqFxJ3LJE62MxpqTNa8W4WOlAg7l6jt5DGfJhhrSm5ytjOJuKqZxMIQtBCJanh/IioF3eTlP8oZX8sZYk8j63ZFsMmfFezxgMLYmTjBXq7Add3U8WvFTkA9SR1PqcVEmdn381+7G1nDg+N93Xuobc6Bmour9KYWL2YiloW2RjpLzCMZUfNUParX3eaDpMDzelUlDMbHsXr2H4+U1W8KC1Ni7sNG55oOuAzC7Vh/eqAdPz2vtyF7CFdBeSb5EkxTHN07nosSCxqsU3/QZTW/4uw7YfnOe+XPwoxHRFIV7n+AGnlNX/hWCQQ8eARH546tdnvOezxl+nSNvHYY2RKq10XVB7O+HwTozdAk6JklTAY1PjB87alIcJbiIjFBTLipyHbgorOgJsX9SuAM9MIUawUV6nwtB+RzB4K1qhuNNdpDuHjPVTbUamEkWayKm8ZlO7zwxif32WmO0HYpv0WoaVK7X4004s2EHzHx7ME0x4op6QTJWYcPxK4X6L+N84udwLdIEffIoVcA0ZJf620QKkDwmInFwVdqyIDeUw9WfY5c8DKjPRpk3aCQuBYlKraZGl8sloeTfpB6ljB5Rb5o0LO7pGQCu+tk6ZiPGJGcQKy/vwRJ/fLzfUeb2Rsl43Cfza1DZEDevhknmBKe2u6Ge3ZMcmzHGk+VVWX0NxVDGUvR5Rw==,iv:dTlSF1OWyTmMuAaJ+rewh/gxk2zJvjoKQJFtM9IEzuE=,tag:Iy+REiRPOrDdGsGkLEBH6A==,type:str]
    key: ""
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
    - recipient: age1jwm8ccjgfy04r9rwh65rehk72j6rkawkpjnf4rcu4ukwlcfyquhq4p2q23
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB3d2dTY3dTTlFjd0dOdmVZ
        RGJoVzNycmFTeXpaUGxNWkc5K3FKQUpPWVFjCnhLN0hCODVwZTNWRWtmc0NGR3NM
        c3ViUDdCWUpkRXhpN2FaRC9qQVNST2cKLS0tIEJNb3JrZHVyUHpRTFZERW9teU9s
        NHJhditjWXk4THMzOEROUlBiaXE0dkEKq/lSahFPzXdSER77js0A1Vu0r6I9guqb
        N2tvKiDoUVZdfDuZz+6U24dU0O1h+VMnIDBGCfujjpEJ+inWX28p2w==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-03-11T19:32:54Z"
  mac: ENC[AES256_GCM,data:UF4i2JsqrMzz9wwdlom6SSivrSHoFTD+rzXBOAbAHjpUCyfGt25DFrkBCmtNHt1NNVIN8GZ9D4gDmps7ol/E6Xo5y+9Q2+e2hsvleKkwrxBbufzOSaAMgaYECSRKxo/NNe9bpyO5NxIrKA/Qw5uB9LopfuO1D543/PMTjFF44R8=,iv:eoQ0VtpHvifBfveRe5gm8Ne9GgR6ZoTP5jsTW9YSjws=,tag:Rt2jRoTmoj4YUUKiUSYm3Q==,type:str]
  pgp: []
  encrypted_regex: ^(token|crt|key|id|secret|secretboxEncryptionSecret|ca)$
  mac_only_encrypted: true
  version: 3.9.4
