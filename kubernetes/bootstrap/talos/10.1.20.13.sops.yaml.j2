version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: ENC[AES256_GCM,data:z8KsFHuwjiJzacUo7XmjKMwtCxv0DFw=,iv:VllqHaLXmZQUpVmhomGnmgx8lNtsNQZwTHa+EIKup7E=,tag:8nw4u/f7TNM6MpvK0ob8eg==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:7mrtEnd3KKPS4TqrpGF5B+/WFYmlMZ8MgWhEnqm//ErApCRNZPewEj6RAj3RqKxYSK5eB6ZgpS9yrlG70lWTZieg0UjAGHMOUHwM29tMuw+JMreCPqcCtum4tqEinOnM7LEP857R5jbWDWCCDflhvXWYCCEYfILhc6LTpChjjrZ8r06cdlhB+UCgsOfTMhpUQXgcWX2IBsPcCHDBppmutUeKL4+yKwTFonfuG2QNKse9QFMoaPsOT9C45cq2SF6F4Agfktp0I1+ue1APgW0OSUJ0yqs0ZzjQ4fbUxj12PyGeUJX9uYEOL1XAshBf61lGsWEIUpHV1LvCRPcHEGu9w2DXaYOobamVbrEDC2oeN/5NPjT7FkBAeofa63//WL69zVX81kyEq4iOSw+1KOzit+zVhvEhFC6vkXmdzLturYI6B4Ud7xqCZXglpWlCeMkLoZE5l8HqJn6ebz/k7qut+dtJwZ+o7Wm+TqPxstghsyMs8Tfn62gdY3HuLaH2KdL+jIPcO4cTHL2PFf8q64wmAHYgzA+9hulHmVbzZYTZt9Kn0m2G/LzeSNloKKJTzTayALWzbWL0jZC/8IOIvCLQ0tn1fTPusa+NTT264IiXN86/XuOPoJUEgUmAHlYkzH6IzHyM+P/WH7fn430C7MOg7RA7pYHT57ohm7b+m3t2Z7AlD+Xh3Daq2y3fY1XjLV2j/lfntEcs2tUxK8uV3bDGctjBxYboY9SNLeKZqSdPRDpDDVkSt+H95pyadVAC8wjO6bW7pJ0RwE7bzgD9r/5PgMoLof4HKmE4NCdn3t7SYVQVL1O3lI5RDM3/+GrxCKek6r4fKta6B3RvpJU4mUsuQk+mMoU1VM/1vOGMPQttkNUM7IUn,iv:GdoyiNi5auikfYLj9JQdifEbwqtfS+zd3D/p+HXJfBw=,tag:Wu5UqMCntu2yuzHWMHL5rw==,type:str]
    key: ""
  certSANs:
    - 127.0.0.1
    - 10.1.20.120
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.32.0
    extraConfig:
      maxPods: 150
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.1.20.0/24
    disableManifestsDirectory: true
  network:
    nameservers:
      - 10.1.20.43
      - 10.1.20.1
    hostname: k8s-3
    interfaces:
      - interface: eth0
        dhcp: false
        addresses:
          - 10.1.20.13/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.1.30.1
        mtu: 1500
        vlans:
          # Services Network
          - vlanId: 30
            dhcp: false
            addresses:
              - 10.1.30.13/24
            routes:
              - network: 0.0.0.0/0
                gateway: 10.1.30.1
            mtu: 1500
          # Trusted Network
          - vlanId: 40
            dhcp: false
            addresses:
              - 10.1.40.13/24
            routes:
              - network: 0.0.0.0/0
                gateway: 10.1.40.1
            mtu: 1500
    disableSearchDomain: true
  time:
    servers:
      - 10.1.20.1
  install:
    disk: /dev/nvme0n1
    extraKernelArgs:
      # Use eth0 instead of eno1
      - net.ifnames=0
      # Less security, faster puter
      - apparmor=0
      # Less security, faster puter
      - init_on_alloc=0
      # Less security, faster puter
      - init_on_free=0
      # PCI Passthrough
      - intel_iommu=on
      # PCI Passthrough
      - iommu=pt
      # Less security, faster puter
      - mitigations=off
      # Less security, faster puter
      - security=none
    image: factory.talos.dev/installer/6e6f23cd5ca6099bbe4be57a2218f628e61314545d5da36dcc6516c59d3be64f:v1.9.1
  files:
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |
        [plugins]
          [plugins."io.containerd.grpc.v1.cri"]
            enable_unprivileged_ports = true
            enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 420
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
  sysctls:
    # Watchdog
    fs.inotify.max_user_instances: 8192
    # Watchdog
    fs.inotify.max_user_watches: 1048576
    # Cloudflared / QUIC
    net.core.rmem_max: 67108864
    # Cloudflared / QUIC
    net.core.wmem_max: 67108864
    # 1Gb/s
    net.core.default_qdisc: fq
    # 1Gb/s | Jumbo frames
    net.ipv4.tcp_mtu_probing: 1
    net.ipv4.tcp_congestion_control: bbr
    # 1Gb/s
    net.ipv4.tcp_window_scaling: 1
    # postgresql
    vm.nr_hugepages: 1024
  # sysfs:
  #   devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
  #   devices.system.cpu.cpu0.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu1.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu2.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu3.cpufreq.energy_performance_preference: balance_performance
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      resolveMemberNames: true
      # Incompatible with Cilium bpf masquerade
      forwardKubeDNSToHost: false
  udev:
    rules:
      # Thunderbolt
      - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"
      # Coral Edge M.2 TPU
      - SUBSYSTEM=="apex", KERNEL=="apex*", GROUP="44", MODE="0660"
      # Intel GPU
      - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
  nodeLabels:
    topology.kubernetes.io/region: main
    topology.kubernetes.io/zone: w
cluster:
  id: ENC[AES256_GCM,data:JBPedlHeOZE5X9Yi1nPX6UYzlJX4YuoP5I1vOp9+gM3kDTXtz6EPtwMzVXg=,iv:vmZB5mFfEVnC2GrJu+a9BUUXXrFRrJkCG0T14kYH2m0=,tag:eGuG80/befo0IQNrPvxsdw==,type:str]
  secret: ENC[AES256_GCM,data:/hPzASa04a4HgSLjMZq9DxKFMrB5jkgoYFSvYlX3lGI375xU/VRPpNmwLT4=,iv:qzUWXcAmO4mUhhoKCKW04LdK54u2/rSmALcyMpIL5AA=,tag:HTPMEpMS8vhao4Sak195DA==,type:str]
  controlPlane:
    endpoint: https://10.1.20.120:6443
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
  coreDNS:
    disabled: true
  token: ENC[AES256_GCM,data:xVRyAF8ZsxtVHBCA0Jm7V/KwovXUvVg=,iv:NlpiVYXjj/mTIIihf10yA3fAEZMtLo3bOQZAcKKldyk=,tag:m8XPb4pIOXhirt63dAKPmA==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:jW7jukn4LwSoebswGRZ9XkFl8gMkjD1KpN972uia/WM3dNKWwpQgwU1+2u43D1Rtjt3Ot0K0XRqP1bFjjqblFYnUUl+M0Ltm92uKFPGaM8aFqANnp0JNivYV4mKtr0K/1AvttkglkAE2Bw8yuaYkHE6tljLFDWRvDND829qH5PTMUDuhsnQVJGsMTeQD2V1C3p4YA4hZ+0qWy9m4n4cs6ze35DkqlLAjtQ6S4gifXGIQ0XUqAaEWkQzc3k/TjXQf6Pt+dpWHhxKKjaBqwxcs+pJvgvWxKmsLwtzjUTfJ+MSks1pNU/idLEkxZtDV7M2t5oresUJ0wfbV8e9l77G2XqeOUf+4qALmy/5etoSOLVKZEyJ0h6qb80Ia667Rg55n/PfLUiv1l/Lxe6XYThxA2w2JFwLXN52JSCxyLLx0qw9lTCELiR2XeKTuMczoQ1R0cj+UgsJi62/m61CttGEzhXqq74y8xFgNx23WnzIJb41UXZZhy6L2imbYv9qrqwvGz0Jsd6rwy+QV98FXItNWk0BgKE+oODjTPFqeJa1bpgin3JwRH1UyP9uqinOOyEiMjUM3CHqd9K0MpkWm7Sg4Wn13Y+m4aBCO7IBKd1oi3iJvCTzJcKZ6hJWwEwrl4M2T+Q6NFHS4L3kPCYVrlrEJhfNtn4D+iTas9TJ6nRJdertlmKJVvmp6dZzzi0X2aRSNEVicRm32HvQ9g+qXYc68EShQdfjqKqd61vIC0Zay2PDrTQXQJFZeCHYieeY9E+UIqJeOJPCPGfH9Kuo7fU8G0AdLfY0k7jfhmQqnPRStBQ7St0THL+ArzOivGJBvARX6CEi1oXpPCTYmDEABW3tm5g53fMry9D21MOX6maGv/hwtc9xzJJjmkqFNwBiirNMFSFqznJrJKXzJKRetjSwXM04n1JIqa8sJ7jEalN+eKdDtvtrc/p/e+lkENatC+R2LOTOXm4wUeynjCkBLQOlPpTFKdZs9C5uAH/3GLVXRAj+d1naxTvxs74OVJLNDr0EruEPhJrVVKVZfyUhGrtQgP7PZBiA=,iv:TTqXETggwnxsTQ1CUsfG54smKpX43SJsGIHf3Q0jCcc=,tag:aLYbieWDEtN8xNwVD7IbRA==,type:str]
    key: ""
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: true
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
    - recipient: age1jwm8ccjgfy04r9rwh65rehk72j6rkawkpjnf4rcu4ukwlcfyquhq4p2q23
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBjN1RMYnIzTjFZTkNoaXor
        ZEpHUUc5ck5NamlXREVlaHI3RktEY1N6L0Q4CkQ4KzBmcGNKWTgvU1FKMGtLcXA1
        RllOSzQ0ZE5xeisrNi9obG16S0RWMWsKLS0tIE5wRmRSZEF3Y0hkcER5Y1J2VE5B
        ajBDM09QZm9SRVhwbzNwVkdjSitsNmMKblPBrqxaMSH2uq9INts8UCMWXaqVoBCs
        ESOyIYmnBsMgrRnDtaADso0isJbErdlrAeExgemFzBTMwFppEGxxHQ==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-01-14T05:29:05Z"
  mac: ENC[AES256_GCM,data:VcD6Pn3+DB620hkEXyC8Bw0EASKqCBaws8SM4D15cJvMZSr3xvNO293Q8J//eKuGZ8BgjSCjqN9gbheuGE4RcdsVF/xbrpxoJ/eS1f/02MooswPlwrQbpJBS+iuE6ah8A0FIqk6pK44OePooxkQ0GpX/CwzKGAoP2tZJQ9SyhZ8=,iv:DplWwGRuQmA7mKhFCYvK5TOvEiUL9cLciagU69ZEKJ4=,tag:KTszHk/h//V3Tr8ggM5hyw==,type:str]
  pgp: []
  encrypted_regex: ^(token|crt|key|id|secret|secretboxEncryptionSecret|ca)$
  mac_only_encrypted: true
  version: 3.9.3
