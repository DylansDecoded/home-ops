version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: ENC[AES256_GCM,data:rR062smLlmUAYZxAJIkSwMXrsi/ezLI=,iv:90SWHjjCXsfm8Ew96zyM1SdokP0zLRJndjfiMsjYVms=,tag:gF3WCZOqEVVIIPDDRWUOVQ==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:qv0swWKydOl2PWJWqXYuuw/iT8OYCA3JaMyXQnQ08ZIEbD4m9vyvDDGvWgjCKlRvLYlgtoL7WJaqSx1R8CrxBWVAOFihgujbfNM+S3kxmdB2p6eGy9IjC4wnCz+2GZfDeeTfuGD8fQ+GXzevxuvU9RPgylMJj+fSE8zjjZty9Xe64eYb3iW+TfZA4GBqFNBzawYxXdRIcKNrjiIciTx0YyVv45uRauunVI6oNie9ZxuX5f9/gDLev0DUZT4FatuC7RrvrLXR55mOLd/AkaOY+53g7FkIhOtCcwk+OMZGSYQd3B//a3HtTt27TpnlQ5D+Ce+IwOv7UtPb3yrqsRuLkHJonO0SnXtu2UbFKRl9T2O7Sw1x6eK1oCBvlADvi0xaAsLfp5wu5tACG0iR0YEY+0rAM4jv3NHeg3wHLeKiOv3bIyuIWbMzM9gzDtGVOVZT1M1jqd0M1RIVP7WF3Tswzxunin5sG00JRGcmxQXpO1BX51PuSAeuQjrk7OJOJEF9mHm8GjEamrz99gqVLY30KqfJtCB9dpajemiOSsd5EQLdaQgbIRCy+k0Lz8ljAVyyrvkFNo3fnunUdMFM0UBYJQUVhHn6JKJ7pptfzVObJ2qKl3hhSzHVKKka6mzcofRHQABKyP/tgdXCZ186lpEna97pv1fdg4JmZCAQa5lp8J8RltiqxYCcm9IE66jXrk+4Mlu4ERgOFusBvKqW5FrpZv8dQEtf+iu+4gICagIozgh1uOFbvgfUxhuBbEnmwuc1RE4IEc3ygnNmi5mPN5+rNJQWIG9BcchQKhvaUtbjPaIlG718uRdcb8Eky8NaTJRG1ILkrlBCCy0eFaAo25Q4JAX/qPiYutyahQV5DS5TLHDeIrwk,iv:rrEvfKqiwRg4feV70ah0rFD12VlOYwH1Ov5IFgnVXS8=,tag:WfN8XVS4px00KX2BYn9vww==,type:str]
    key: ""
  certSANs:
    - 10.1.20.120
    - 127.0.0.1
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.32.2
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    extraConfig:
      maxPods: 150
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.1.20.0/24
    disableManifestsDirectory: true
  network:
    hostname: k8s-4
    interfaces:
      - deviceSelector:
          hardwareAddr: ac:e2:d3:15:fd:f9
        mtu: 1500
        dhcp: true
        vlans:
          - vlanId: 40
            mtu: 1500
            dhcp: true
    disableSearchDomain: true
  time:
    servers:
      - 10.1.20.1
  install:
    disk: /dev/nvme0n1
    extraKernelArgs:
      - net.iframes=0
      # Less security, faster puter
      - apparmor=0
      # Less security, faster puter
      - init_on_alloc=0
      # Less security, faster puter
      - init_on_free=0
      # PCI Passthrough
      - intel_iommu=on
      # PCI Passthrough
      - iommu=pt
      # Less security, faster puter
      - mitigations=off
      # Less security, faster puter
      - security=none
      # Less security, faster puter
      - talos.auditd.disabled=1
    wipe: false
    image: factory.talos.dev/installer/1be6923a14b1498bc2930c02b286cbf9d98764032fb6a8659b8fce7c1476262b:v1.9.4
  files:
    # Spegel
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 420
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
  sysctls:
    # Watchdog
    fs.inotify.max_user_watches: 1048576
    # Watchdog
    fs.inotify.max_user_instances: 8192
    # 10Gb/s
    net.core.default_qdisc: fq
    # 10Gb/s | Cloudflared / QUIC
    net.core.rmem_max: 67108864
    # 10Gb/s | Cloudflared / QUIC
    net.core.wmem_max: 67108864
    # 10Gb/s
    net.ipv4.tcp_congestion_control: bbr
    # Send and accept data in the opening SYN packet
    net.ipv4.tcp_fastopen: 3
    # 10Gb/s | Jumbo frames
    net.ipv4.tcp_mtu_probing: 1
    # 10Gb/s
    net.ipv4.tcp_rmem: 4096 87380 33554432
    # 10Gb/s
    net.ipv4.tcp_wmem: 4096 65536 33554432
    # 10Gb/s
    net.ipv4.tcp_window_scaling: 1
    # PostgreSQL
    vm.nr_hugepages: 1024
  sysfs:
    devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
  features:
    rbac: true
    stableHostname: true
    # kubernetesTalosAPIAccess:
    #   enabled: true
    #   allowedRoles: ["os:admin"]
    #   allowedKubernetesNamespaces: ["actions-runner-system", "system-upgrade"]
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      resolveMemberNames: true
      forwardKubeDNSToHost: false
  udev:
    rules:
      # Thunderbolt
      - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"
      # Coral TPU
      - SUBSYSTEM=="apex", KERNEL=="apex*", GROUP="44", MODE="0660"
      # Intel GPU
      - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
  # kernel:
  #   modules:
  #     - name: nbd
  #     - name: thunderbolt
  #     - name: thunderbolt_net
  nodeLabels:
    intel.feature.node.kubernetes.io/gpu: "true"
    topology.kubernetes.io/region: main
    topology.kubernetes.io/zone: w
cluster:
  id: ENC[AES256_GCM,data:XNdDwNzGTd9KmQoh9Y1WTT3sKLK3LsvsQePgt3C0jIrns/PN17S8VDm1ryo=,iv:E2horf0tqx6K5YQDeql44x5SEXrS+rjQvqvl1oNtwNw=,tag:2s8g6KiImR7Fm/CuNcS2cQ==,type:str]
  secret: ENC[AES256_GCM,data:rP61X7+xzeXtHxkVvdJ0iBjjObsKr1bTdDBLOb5cTtgmrwDmHacSSeb7Bu8=,iv:q79TTjlh9QLP92M8yfJVuljY7QA2BFoSPtlKk1WtoNA=,tag:3VK/nkhrRcl/oIBzQGzsWw==,type:str]
  controlPlane:
    endpoint: https://10.1.20.120:6443
  clusterName: main
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
  coreDNS:
    disabled: true
  extraManifests:
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagerconfigs.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagers.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_probes.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheusagents.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheusrules.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_scrapeconfigs.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_thanosrulers.yaml
  token: ENC[AES256_GCM,data:8eerjgsgf/D76b/Oth35lTfbxHIVOLQ=,iv:lhSznE0EwxH3KTParqz10cMcWWRLFlBsby5eU/a2XnI=,tag:GrKVsJo41TiCqwzSEPdwfQ==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:RauWk0/eWJ2rKdbBvuSIN33UfSqo9MOaS+bqbppDLfDg1wLWZkm5vRhDH0iH7o0Pz1IjX41nj/7iKVoLisMkR8JxjK03bJ3HSay6sezHknlP49vzQqExMFm42cMRR5i7tUCYbbeuARQuRDzIFpcbWOx9gkVwMPrFSi8ZVfLqw1HeVzrGqhiAQsvTfq1NygEEqW4xtPcXjPzID2hlJAo6e89fqUTtZx9nOWGRn1WtlgdqdJOH2EHF/tCsnV/WYCMeu9pcJIJ/M8ChQLiYsdyeKrV6sBAdEb/mBkb6Bdtr31m0deY8PWmuFMFyPFx1giWypPNvQ0nUZkoCnnKBSt6rqHdMRcuVzVElYoQdIIC4IeeCL68BAu4Djb19ruia9jCazl3aQ/CGmNGBd+dbCTAVgLsTKeYMaF7DON9+FKbpaQX9WCbRMpG85pkCEiXlv09nMAcedvsxswVd93OEaSz3sEuiiLRRGUuKOrRd1XyjDvAnoPBnds8XvAYoLyVtDKTSFVhJcvin74XejloUxSK+lnevyilqemU6be/AFRZkoxTmW+lehfzpqC0QDRD4FsaC5adDg2oEuql7EUHqBLCw20lqhuVVwR7sqMJx2dU73ARsXiMK9dbDsm+qo0Ku5XIad5wARDciJXPZwPhg3dlqhS92KJ76O9mo9JfKQ6C3hmuvN+FpVD++fohyieTqH70fblUkbJlX1pasWGSZ164oeU3wgmZShNNDfkByzqkADswu8Q7jcJWKFJcUhJSjdotv2llit7+gjWj+kZy7RovYSwQc/a5+PKlAQYz2nHyXHdXofJvxm7uvkwMU+B6VG55RpH2nlD62iOPcf2j+JnPHI/QapyFzAwn7oj89ANY/FyUkMjgs+srxQRibgE73uQV/wpcqKvf7oyij94aQjwcY7v5uJBBvoQIY9GP5ADL0HsmxxQZS7IHyREcJqVW9VpY2VekIb/1U0738sfdFEUl6d1gXQx2jugh28AETvBZ5puCDZa7T77VLNS9PJYcju22Tdn2WKd06W+bVYF5JUJ9Ec3Jo8Vjl21Cl3SqarQ==,iv:1miZ2tZ1iYP6ssBwt15DgFfuT09kWEOPqMR5cU5ErP0=,tag:axNYRPqe1vjZdYuIDlu1Aw==,type:str]
    key: ""
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
    - recipient: age1jwm8ccjgfy04r9rwh65rehk72j6rkawkpjnf4rcu4ukwlcfyquhq4p2q23
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBaRlQzaTQ2WkZVUFZtb1dG
        elRyQkpkL0tLWVd1cnZ6NXhrRlkzSlRtTTMwCkJOMFhRenltYUVZYXgzY252UzJP
        VmZzczEvNnVnM0lQc0dodHFmSWZpMG8KLS0tIC9tUkxyV1orNzhqb1Y2cVNEcWRQ
        Qk1JWGxLZEhHTFovOWQyd2xvMEdYdlUKHzUAJZAn8g6/vdofFcUyGkhSvR7l++Wi
        g9sU6SF2TU0wcWvA6rZsVO35ExK+3wMnIYH3i2hWqdbGBu74+OZUnw==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-03-11T19:33:46Z"
  mac: ENC[AES256_GCM,data:r0MJTw7uuc7xfTRRQs/QOabNF16iUErcRID3B7KGiGT9VzELti6sjyUSN4Xq8857+Eqx6pjOL5iisokx1EIajfufTrO+8qCoea1eNQKbGM72eAjc5YfRTP8T5hNy4zruv0iiE+Sfj85n7GhGGxK2GU1c2WkFuiS4uw2kSWyQ/Qc=,iv:x5NsWpHcCDm+h/pq1ostxvS51/6D0BfFAOSyBcAjbuo=,tag:wEs4ir6vnKpYzjycY96lKg==,type:str]
  pgp: []
  encrypted_regex: ^(token|crt|key|id|secret|secretboxEncryptionSecret|ca)$
  mac_only_encrypted: true
  version: 3.9.4
