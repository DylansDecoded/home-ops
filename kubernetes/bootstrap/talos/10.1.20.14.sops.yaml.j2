version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: ENC[AES256_GCM,data:BL3QIkQMgmBhRtyRkUPM2OhJAg8B3MU=,iv:RM6J8NdjZD/osHD3BdR4AGu/nmo+JfLfFp7v6dht+B4=,tag:x+pftDq4AnGsHFazRI+a4g==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:Lhw6TRMMpLeebtNl1AS+0LchWYwh2tABBla/eqntJUArKvrx6e9mGI1Zcumd7LpnnJC35P/iyMDycjP391IlrfNuKlblFoV/8wOeRGwBCwc4H210DzZXZJffobupn+CjWcGM7i8leuxsH46ce+cHYKPKZRNEwxAuIsoXW8v3cEEfL5xc+O7nNKEnb7Ic59/tVwmEvPj3zx85zEt6AeT9oME1BXTUIxuZJJ63afT7YqoboOc9N7l9FTegdkOZ1W1G4nO0jxMFajAc2E0R14dh2ERjEsds9TwISuye96fvhzk0mBDBuQ1hcftbn/KWRexcZb6zMN5rkTrpVK3NECsREPwJXrbCMP44EswcU6HoSqTpXt4XNgQu9I687K6QBVq83oFu/XvUvD+o1GCgfSu8ipOpHxC4U6pkpKY99pxotpHeegXLhdFn5Dm4lI/FEKA+MJ9AWjSzyDW4qOYbvvSgDdSsryhf9jpVErY+q4ZhMKjSd30Gfs5nz0kOrjTTgY1fJ3ZgAyT2Uqmb3YeLyO2d3LmrsrKtEF0Bp+Z56GZF5VpxEECY0aDcaWU+ZJdy5iZqJSRDO7ByUrTHa1jzIpyTmpz1x+CiPVmSuMa5kjt+TxQv4hycV9BCDpeYVQhqgWzicaUzjQk0jDcct82H1e9B1prZK4qPOigah/hIMAnFfnU1xnTdCGmuuv+Pdau6S2C3aRSxyNcZRUUXUUUsrpBx+GSeFv+SU6pOwFMhqHJZJXH//+ruOtZjucjDqxEJwFrXEo5s3AGBkJ2hW07djgttxDJBhbBNOcq0SBMQQsU00w6WywK07ltSb5zf5PPCmH1oPG/3edObCYl/dqtKdJSbJjxd7B33Pl/AOGzpfItSnlaEgWfv,iv:h9ww1EzbcdjUHA84KukQIC3TGkTXFcK36vi8E+OUG8I=,tag:w+v+bQaNy+rmJsj0rq7nqw==,type:str]
    key: ""
  certSANs:
    - 127.0.0.1
    - 10.1.20.120
  kubelet:
    image: ghcr.io/siderolabs/kubelet:{{ ENV.KUBERNETES_VERSION }}
    extraConfig:
      maxPods: 150
    extraMounts:
      - destination: /var/mnt/extra
        type: bind
        source: /var/mnt/extra
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
  network:
    nameservers:
      - 10.1.20.1
      - 10.1.20.43
    hostname: k8s-4
    interfaces:
      - interface: eth0
        dhcp: false
        addresses:
          - 10.1.20.14/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.1.20.1
        mtu: 1500
        vlans:
          # Services Network
          - vlanId: 30
            dhcp: false
            addresses:
              - 10.1.30.14/24
            routes:
              - network: 0.0.0.0/0
                gateway: 10.1.30.1
            mtu: 1500
          # Trusted Network
          - vlanId: 40
            dhcp: false
            addresses:
              - 10.1.40.14/24
            routes:
              - network: 0.0.0.0/0
                gateway: 10.1.40.1
            mtu: 1500
    disableSearchDomain: true
  time:
    servers:
      - 10.1.20.1
  install:
    disk: /dev/nvme0n1
    extraKernelArgs:
      # Use eth0 instead of eno1
      - net.ifnames=0
      # Less security, faster puter
      - apparmor=0
      # Less security, faster puter
      - init_on_alloc=0
      # Less security, faster puter
      - init_on_free=0
      # PCI Passthrough
      - intel_iommu=on
      # PCI Passthrough
      - iommu=pt
      # Less security, faster puter
      - mitigations=off
      # Less security, faster puter
      - security=none
    # gasket, mei, intel ucode, i915 driver
    image: factory.talos.dev/installer/6e6f23cd5ca6099bbe4be57a2218f628e61314545d5da36dcc6516c59d3be64f:{{ ENV.TALOS_VERSION }}
    wipe: false
  files:
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 420
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
  sysctls:
    # Watchdog
    fs.inotify.max_user_instances: 8192
    # Watchdog
    fs.inotify.max_user_watches: 1048576
    # Cloudflared / QUIC
    net.core.rmem_max: 67108864
    # Cloudflared / QUIC
    net.core.wmem_max: 67108864
    # 1Gb/s
    net.core.default_qdisc: fq
    # 1Gb/s | Jumbo frames
    net.ipv4.tcp_mtu_probing: 1
    net.ipv4.tcp_congestion_control: bbr
    # 1Gb/s
    net.ipv4.tcp_window_scaling: 1
    # postgresql
    vm.nr_hugepages: 1024
  # sysfs:
  #   devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
  #   devices.system.cpu.cpu0.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu1.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu2.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu3.cpufreq.energy_performance_preference: balance_performance
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      resolveMemberNames: true
      # Incompatible with Cilium bpf masquerade
      forwardKubeDNSToHost: false
  udev:
    rules:
      # Thunderbolt
      - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"
      # Coral Edge M.2 TPU
      - SUBSYSTEM=="apex", KERNEL=="apex*", GROUP="44", MODE="0660"
      # Intel GPU
      - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
  nodeLabels:
    topology.kubernetes.io/region: main
    topology.kubernetes.io/zone: w
cluster:
  id: ENC[AES256_GCM,data:3RsYAjDKno2rasW9bv+6eefuLuJJHsLyEiO0uvuntGlrP29Qj+vEIHWJ4zU=,iv:JKT95DzW+gFH5NTK/lgK0QzC2s05nnAUvyYDDyPsVds=,tag:tcdAK5NrAWT9YHsapr9QRg==,type:str]
  secret: ENC[AES256_GCM,data:0CEKxZ+6KoffE6cuBNvq/llMJKAYq8zloVX/Z4ATBfr4MtUKJ18DI5ZsmnA=,iv:IhjWMtVfSoa3JZScQvz1Ic92bCgmejMlEACU0rFimfE=,tag:uOEJqJPqLQg93k/nSCe9BQ==,type:str]
  controlPlane:
    endpoint: https://10.1.20.120:6443
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
  coreDNS:
    disabled: true
  token: ENC[AES256_GCM,data:03OoPs2n50MTnSlJIJpR+tJ+HNIW4v0=,iv:a0EOjMWLppQvWk2cHTZw8cKjqGgnGKg6D0lm4JokR+I=,tag:slvwWEKJ9LOfPZ11AzpEUg==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:jxooIpGeRoaM3JKsG04Y0L9Tscj+5kIfIoN8sDJwYef5V2h1rbdXONsw9b0yeKA1Jlnb50LcOKTGxf4q6WNHocMB0FYrQ3e/D8RjPL5DIw5IFCHK3K7L4f3C+lyI1NKMKVqKp5cqO5lRYsEfmSNpMM0S3WmCo1UzgVvsdDmYvEsRLawG+6rTdlxcHQ1zELNbafAnvDr0ncohzIg/TNHAsla9voFRABkx8g+EcigFFJ44B90oKhh8WZk23cMHcyhmUOgsZ1ZGRsDSE2GWUjudQVDhKfF+NQgBG2+UWxRNVck5jgm4en8aVPrnnq8CIX3EYH9PO6HfwD/BxeuAfJ5OdcLpUJmXKg4qyZvI35Skg64FKzAlIUusLzP4vlR+zeuzHNPmeRAxTJyMAJ2iO3e4/HaEWKpkPJwaBEM1qytDH0p1BgUnTtlq0LfsWhsTa07+xyIan4wFexRA5/6RhgfaHJV2SXe0/Vk2IkbsEvWpudTR9hhvtlYB1YzG5GUVCecy0XeS3g5EGECF2Aw+oaijzraUdGhbTbnbIZibuH01H3E0N5U0vsqHyx482lHI/OROIQlwEMJll+VBFTYFjoXpa6IcyZtCGzzVkgmMfk4zl/X0QDbxJv23pohG+L+Y4QVElenn+GlhJ1SfiDd+PpjNcuslSB9AN9KQ5VyS44xk57H0CD5G4eRIikOPPJCGiwoyJ5KlG9G4uM/21l5Uf0YHOfNVd4MK7vwEuRAjaeT7m+AByf00frW27SIgWOnHnIoYu8cMs8OI5xI5Xd6eVdyFnp3uL+PTTXqU2/e6W8q2epUsqhqWrVingZlZIFIOFS+o9+txg2SUBLCoXXfGPFa5pKZ4EUSUz/oQZBBaINWqwIwyOi0qqkxTNnUOxwMieXaOZ0KUfgvyz2pLauMYxIdUf1A2lR5+gmSz3XAhKdWckbeVJwmQNmn311SZi6PivpVunVUQV8VHIP9qikdOFvADICJ2xB5MmQDfHfSGU2NAZ3W6zxOZ0+8si3MiTOrgETPtG+u/Hpn+qvrisHVRGc25gHyHiAM=,iv:NfCj8ideZfwOf6v7RsiNISbko9RpobF+f7NkKmQiOk8=,tag:x7RVoJOSESXUHgl9nGQsBw==,type:str]
    key: ""
  apiServer:
    extraArgs:
      runtime-config: admissionregistration.k8s.io/v1alpha1=true
      feature-gates: MutatingAdmissionPolicy=true
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: true
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
    - recipient: age1jwm8ccjgfy04r9rwh65rehk72j6rkawkpjnf4rcu4ukwlcfyquhq4p2q23
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBERW02SWpMbWh4OW1nUllE
        YnpmTVFkME94SitqM0E5ZkZOOVlyN0JRenlJCkFxcU5HRzAvNW5hNFZqdThLKzd1
        MXVmWHRIdThGTkNFdmcyb1gxSkg5Y0UKLS0tIHAvTDUxRVVKWUFaejlPSEJzSytl
        SnlpSzloN3pYWWhJSHRHNEJEV0FkdXMK9/v8uuCwP/2p85zpVD1SnLhyGGWmSeeK
        emgBLxdJ+X/JXLkvEd+R7+jZTSMdS7buBQwwS4GuUDdL3BzRJ5WeWw==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-01-24T03:08:53Z"
  mac: ENC[AES256_GCM,data:No8hnR/yJuqS4MjwN4SCSiyqfJaxR7RtfMBUBWjCmtkqy3otsjVComE+7byiC76wuO400Bh+yOa6lFA+oB6Rma7/Yg3E4XNQAf9F1HQR//Hp7enkwJ2KQqiYEJKCL3lNB16pY2U7vUW96393uf6rkEPh7CobGfAaWHRFxuY+7TE=,iv:7YoyhYeZqX3gU/KPL57RmT02qgjGWFhFXLw6ZQbrN1s=,tag:SH1eplxAf5JCs2oFNWDcXw==,type:str]
  pgp: []
  encrypted_regex: ^(token|crt|key|id|secret|secretboxEncryptionSecret|ca)$
  mac_only_encrypted: true
  version: 3.9.3
