version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: ENC[AES256_GCM,data:wPXcxQleiQclIw/AcgkvCwkzkcxrtb0=,iv:sPpDUZPpXLnqxpkNpeXIZxZpAonzp+b/9DxCK7fBrrw=,tag:oxnhYd3Pxi0TLwJ50oju7g==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:qj668jX+BvFTWnq/WBClb7DwpehATp5jjo5z7hyf5PuN+BucP7WT3xOUsqhO5d0jF7suNyKwTL+y/G6G/CZ4god2u9eJiDWl8CPhwSq+QonaFpMuDL/BxJkDm9NOTWutvYlGwgSQVvihte7exn9IHNyMG1jof4AtJ+O2xQd/YYHAAJ1GyoSDWLiwJxPGgLIRuKISZokCMAsC6hqd1sagafyr8dO12oMFWl5AaXMZNJj5EnNBA+ZcNkbUg6FpQ3O8Ye1JGTXfBaIFuYga7X5hTRMpA/IQAbjZENAOr/AUEfZhUFGNeMBCTDpMLcIeC4AJdZlkBaY587oQC9XHqtRfvQ3R99hGm3gO1XkGZnzKYk+i3BhadjSGF1Cx7RE67E0HSZ0DMRu1l+2c2xjDAOFtAXDel4zkeju5MYdciauOVRJB+O+IC7dCh9WVCx4BTmT5r9rW19vFtOAPgLmvIoUBCFx+X4yutt401nI7Juk0fhLOr37Z1C35zeW01Pb5i2BrD6WjwhkkWtAwXVnOed9R2iGGIX3Mn7ZNlx03e09IHAbXqCcyQd1aBGm59mwn0ss6F9TFJbLmIRprUZ9Qel5GQiJ3IwbZWw+RX68W9dGxKrEDKyOdCbemjhCbFTMVPwLLnuA178PavVI+jFBEcsw2OwS0Q+3SQIbYMWCdKHsT6Uhl7wsBikRFXphE79TzdcP44AjgtmOThw3r3GMpFMD8hGCM4NriQNy9jyEnnNgyqaBYv1R51anssAmmNIqkST6WgmykiLe4hU2F6ME233fZsZ2bXIrhS57GDbGySWrsYFByK6wQlSGXOroOtEB1UwdIR0Qdr34QwK5Xj4R1afWPoY2u777P0a1TojC/kEQYdGBzU2RC,iv:wMma8vxk8g/B5OZ8Q4toJ5qs+BcOOpRjWW1DD4hDRoA=,tag:HoEU+8rGH/zdPMllx4vyOg==,type:str]
    key: ""
  certSANs:
    - 127.0.0.1
    - 10.1.20.120
  kubelet:
    image: ghcr.io/siderolabs/kubelet:{{ ENV.KUBERNETES_VERSION }}
    extraArgs:
      runtime-config: admissionregistration.k8s.io/v1alpha1=true
      feature-gates: MutatingAdmissionPolicy=true
    extraConfig:
      maxPods: 150
    extraMounts:
      - destination: /var/mnt/extra
        type: bind
        source: /var/mnt/extra
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
  network:
    nameservers:
      - 10.1.20.1
      - 10.1.20.43
    hostname: k8s-4
    interfaces:
      - interface: eth0
        dhcp: false
        addresses:
          - 10.1.20.14/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.1.30.1
        mtu: 9000
        vlans:
          # Trusted Network
          - vlanId: 40
            dhcp: false
            mtu: 1500
    disableSearchDomain: true
  time:
    servers:
      - 10.1.20.1
  install:
    disk: /dev/nvme0n1
    extraKernelArgs:
      # Use eth0 instead of eno1
      - net.ifnames=0
      # Less security, faster puter
      - apparmor=0
      # Less security, faster puter
      - init_on_alloc=0
      # Less security, faster puter
      - init_on_free=0
      # PCI Passthrough
      - intel_iommu=on
      # PCI Passthrough
      - iommu=pt
      # Less security, faster puter
      - mitigations=off
      # Less security, faster puter
      - security=none
    # gasket, mei, intel ucode, i915 driver
    image: factory.talos.dev/installer/6e6f23cd5ca6099bbe4be57a2218f628e61314545d5da36dcc6516c59d3be64f:{{ ENV.TALOS_VERSION }}
    wipe: false
  files:
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 420
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
  sysctls:
    # Watchdog
    fs.inotify.max_user_instances: 8192
    # Watchdog
    fs.inotify.max_user_watches: 1048576
    # Cloudflared / QUIC
    net.core.rmem_max: 67108864
    # Cloudflared / QUIC
    net.core.wmem_max: 67108864
    # 1Gb/s
    net.core.default_qdisc: fq
    # 1Gb/s | Jumbo frames
    net.ipv4.tcp_mtu_probing: 1
    net.ipv4.tcp_congestion_control: bbr
    # 1Gb/s
    net.ipv4.tcp_window_scaling: 1
    # postgresql
    vm.nr_hugepages: 1024
  sysfs:
    devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
    devices.system.cpu.cpu0.cpufreq.energy_performance_preference: balance_performance
    devices.system.cpu.cpu1.cpufreq.energy_performance_preference: balance_performance
    devices.system.cpu.cpu2.cpufreq.energy_performance_preference: balance_performance
    devices.system.cpu.cpu3.cpufreq.energy_performance_preference: balance_performance
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      resolveMemberNames: true
      # Incompatible with Cilium bpf masquerade
      forwardKubeDNSToHost: false
  udev:
    rules:
      # Thunderbolt
      - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"
      # Coral Edge M.2 TPU
      - SUBSYSTEM=="apex", KERNEL=="apex*", GROUP="44", MODE="0660"
      # Intel GPU
      - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
  nodeLabels:
    topology.kubernetes.io/region: main
    topology.kubernetes.io/zone: w
cluster:
  id: ENC[AES256_GCM,data:8kt+uUmslXrgxfZYt79HQm5mP6yvDt45HRdBgG/tu/Em0NU4N9RSke67Yo8=,iv:7kW0pqJrMmNKPNpsTYiwgjPZJnPwDSJik0qDlRRkZfs=,tag:RCexYnj2fQOr4c1CMkPC0A==,type:str]
  secret: ENC[AES256_GCM,data:o/9yrLVJrR/LGdOezatxBJOTkBqlT712tpQfqL4S/uMB5CZV4EbwkqwLWr0=,iv:tm5Gud9LmOoFRfBT660BPQaepMdHaK87sjWimHcSiGQ=,tag:0TGNM88gIdcpjf0hHjLciA==,type:str]
  controlPlane:
    endpoint: https://10.1.20.120:6443
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
  coreDNS:
    disabled: true
  token: ENC[AES256_GCM,data:UsAvRVDETBNoDhdl5pbsHqM7WA0JVbI=,iv:8z2AE7JeiGS17jxjyiKHtPlQOwsx/zPbNXXXpgyw5zY=,tag:UO5Nsa+VM5/IXihCZX3Q9A==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:0clzt2f/i556sWPquz73ZK/0EYxWjbhbLg5PxZxIB2xP3m7BSRGpEcXuLMv8JC3cmRR8NEoRDzWCOQCt8+XArzzF+fBtb8HMq0qjNsGZrtUXkfwJmZD/Oq94bTk4kva0ghZAKtRAjHlJkhv8C1ajUyqNJFRjWx6w0WgekbpDovQo3kJ9LHUJmnXHe8dSNysj+rVLN+6eH0U4eTWisP4+d7DpRbupLcBE4729sqQpjBD80RftvVktXzAqDMmMSPLu+6jfSSed6jUuee6b1NNIr0lCDv0qwuGVgsHWMzumMl8O4y9rsCQs6dWOE/POoLMpsdx9YrhHvWEvL9KIm8AoU30fBTZfOFzxZ7g/m6JeUcYdYn6uCBW63bIbytjcblYB8PNMuQyPPIWdVkh+24aGKqWruYzPyHRDTiDdbxMQwotfpon4y24j2YPuSUgybf/e7qhOndNUV7Odl+APIbxZL/BzCra2s5mu2mlwhBbNhX3ng1jP/ZTLT3PMo/5TiSCKfEUauu/wCSl/2jwRgPoKUdaVZL24LVUapuVfrA8E+M3NHiwj4F4K8bsLVYMqomW/WEJqP1ycZNYX5PjGus4YFhVPMOyAY8ZpaFYJFIovFLXiH/ySNSbqnY5Pnlln9bC86OLbjX3mPFpVDSBt2tIO1qLTvvPaLSYfbMOQ3SCP7KfthmJRsT5tsE+9SDfu2DC4aKIp+dNTHvRrPnFbwjqreKY/shaMdat2URMlGrbSpq4h/TaqjihQHQ5xaY5hw0eFTYvoBxiHTnflEn6au8NS33LWn6wyK2l5Oox1WEJTmHywBKCOpMWN+cB22jSNk2+64a0rZWakFMs8CpsTXVf8CknB19Y3jJtGCzJQSb5IQwgDWegDZcslA6E7Aij6+I2lI9Guc31/H1q7tROmVifnwg4nrO0/iuKaJ8LIyJHqnwFAPvW12lSvzZAr/y48WkqVxAKLkD0PmuBQEtbuEcWWmpgQYBcQVrG6+GfXxrbd1aqTt4sn7f/0gSn8BhYdhdR62EdsD9xMaAXg71eCQHxPf3hONHE=,iv:wSHFc15d2+ks2sFHmoRs191HoHZhV4OHv9FQVl/Irxg=,tag:0bNqA0utmY/1jZmuLWlJ4Q==,type:str]
    key: ""
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: true
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
    - recipient: age1jwm8ccjgfy04r9rwh65rehk72j6rkawkpjnf4rcu4ukwlcfyquhq4p2q23
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBiMTBucTVNT0Qra0pyTjM3
        WFprQUhsTXdjU1dKZU1TNU0wTk1yVnhiaGdrCjUxbjFLTkVPRllqQnZKSy9PUXNO
        b1l1anV6aVNJbFp4NmlRVjhGSitpM0UKLS0tIC9XTFNJTXNyZFIxalZoQW5ibmFL
        czJiZFZkd2dWVTk4T1QyNGxzeG9tREUKnEXn5mVLSVvVDywztfb5PA9WUw+jVaIW
        PWiyHeoCfRTbG3wTWX0f+7qkxHuKShydqu1I5sL7kOCJQL6+SvcR/Q==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-01-29T05:00:52Z"
  mac: ENC[AES256_GCM,data:kaRkZu+xxZdZLFvRJxAesntSfobhCG9hhbvKNERY+mXTsOFwVi1g/C0Wdzc97HPodTKwQmOQFMLK/HLftB4KYuBCYrqI0Rl6yICjn8E20UvZSxOtJ4E+lxIXM4jk31iqJlvUV8SVHEqMjJoxlLgMWX6proG0f3oPkC8cFX/Mdps=,iv:PnhYMGMPWsf9NiThrR5GXS7bGMrnLR21zONbTjibyMk=,tag:rCB5jNiXZTTK0K4jPod1zA==,type:str]
  pgp: []
  encrypted_regex: ^(token|crt|key|id|secret|secretboxEncryptionSecret|ca)$
  mac_only_encrypted: true
  version: 3.9.3
