version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: ENC[AES256_GCM,data:bERkBfdyekznOtdZywGbx5PaAORGfVQ=,iv:N3oAQnfke3WvvzXEee1zbpWi23RyVXH1KHEdc6fYAcw=,tag:mxwn6kem+c/hDSr3QpcPBA==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:7+NPg+PuvDyaoOdDy8GMt13WdyUwFeG0ZnFpgL5EZfKGWkpvr0vYE6oqaV8ZNnUH3Frygo4xtlX9ex9I9rBTdVyLpbr8843jiLaK8wHLHOyf0ZxASoGYMVOgUgm54P75vFXRXs1jym97Km2/vX9TxzKognOkvA5YBYlOJEY4HOJpoESd5w+aJc5JrSV5m92XLUy0KB2jBL6oQq0wXB4Zvemhma90CHS8oectpzAeI0hX1VK1/TmesiB/3sSoTmA5QD/2MlNbu3dNPSkQ+Wn9XOZQS57LvF3NQvHN8QphmIJxz34S9YPto7BJt51KEQZr5TlvuGp/2d5p+rgkumalfiXXWS/jza04QP8l8k5nx+W/rzLqi2740mCaBHCwISBDrOk3krTy/eAq6klS9k+eGRrk1GBaateIYsdkn/t9WA7KRoZXOedFu95eDHIGHsbHrhCIgVf2Es4F9faqwiccBK7ptJebGDaLLu/SE8qSCCOmBXRavq2ZoHcLpmYAisao6hl7UPv/fJw93aX0zWUvMCwPYAoMdyGTps5MVY93IhHepJ3iGDXKE3QH71dGNcAmvypaIUb3s9IVH3C8OhaZ4Lajvr8Net2+8OM7vWWMVMlda+5RAq9X/PEXXBQhg0yeUcu67FzVhvcs4CpM/xbsC+gTvMzo7jCKLSgSLSCSw1zgJAR2RIN+hT8ohVQL+NC2VuE0P/WTMpQOkO8pjILWU2Q5hJdVARTFen2OC4P12fr/D+W+MvpepKg/e0LUEgmCDh22HrKDA27ogEzvcGJgZY/QrgB285G/kXyCC+n+PWY2hyagILqy18XhRv28RMqw7FDYCQm4Fk+kC6IvjxwegLVq4g6YZbfPJE4s7WAIMS71gr8E,iv:Um9qBYRC5t7AarjOOHxHzMA1kwEKGFy4GNUBhfxWgHg=,tag:T3AYmq2Loh+nFKqWrsq6lw==,type:str]
    key: ""
  certSANs:
    - 10.1.20.120
    - 127.0.0.1
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.32.2
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    extraConfig:
      maxPods: 150
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.1.20.0/24
    disableManifestsDirectory: true
  network:
    hostname: k8s-5
    interfaces:
      - deviceSelector:
          hardwareAddr: 10:62:e5:1a:80:18
        mtu: 1500
        dhcp: true
        vlans:
          - vlanId: 40
            mtu: 1500
            dhcp: true
    disableSearchDomain: true
  time:
    servers:
      - 10.1.20.1
  install:
    disk: /dev/nvme0n1
    extraKernelArgs:
      - net.iframes=0
      # Less security, faster puter
      - apparmor=0
      # Less security, faster puter
      - init_on_alloc=0
      # Less security, faster puter
      - init_on_free=0
      # PCI Passthrough
      - intel_iommu=on
      # PCI Passthrough
      - iommu=pt
      # Less security, faster puter
      - mitigations=off
      # Less security, faster puter
      - security=none
      # Less security, faster puter
      - talos.auditd.disabled=1
    wipe: false
    image: factory.talos.dev/installer/1be6923a14b1498bc2930c02b286cbf9d98764032fb6a8659b8fce7c1476262b:v1.9.4
  files:
    # Spegel
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 420
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
  sysctls:
    # Watchdog
    fs.inotify.max_user_watches: 1048576
    # Watchdog
    fs.inotify.max_user_instances: 8192
    # 10Gb/s
    net.core.default_qdisc: fq
    # 10Gb/s | Cloudflared / QUIC
    net.core.rmem_max: 67108864
    # 10Gb/s | Cloudflared / QUIC
    net.core.wmem_max: 67108864
    # 10Gb/s
    net.ipv4.tcp_congestion_control: bbr
    # Send and accept data in the opening SYN packet
    net.ipv4.tcp_fastopen: 3
    # 10Gb/s | Jumbo frames
    net.ipv4.tcp_mtu_probing: 1
    # 10Gb/s
    net.ipv4.tcp_rmem: 4096 87380 33554432
    # 10Gb/s
    net.ipv4.tcp_wmem: 4096 65536 33554432
    # 10Gb/s
    net.ipv4.tcp_window_scaling: 1
    # PostgreSQL
    vm.nr_hugepages: 1024
  sysfs:
    devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
  features:
    rbac: true
    stableHostname: true
    # kubernetesTalosAPIAccess:
    #   enabled: true
    #   allowedRoles: ["os:admin"]
    #   allowedKubernetesNamespaces: ["actions-runner-system", "system-upgrade"]
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      resolveMemberNames: true
      forwardKubeDNSToHost: false
  udev:
    rules:
      # Thunderbolt
      - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"
      # Coral TPU
      - SUBSYSTEM=="apex", KERNEL=="apex*", GROUP="44", MODE="0660"
      # Intel GPU
      - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
  # kernel:
  #   modules:
  #     - name: nbd
  #     - name: thunderbolt
  #     - name: thunderbolt_net
  nodeLabels:
    intel.feature.node.kubernetes.io/gpu: "true"
    topology.kubernetes.io/region: main
    topology.kubernetes.io/zone: w
cluster:
  id: ENC[AES256_GCM,data:B9w2aKQDmFYv3nvdeXUkhLhL1tiRkTE5Wh0tocNhqRKvKLjpmRLy+/Y1LeU=,iv:lXnJw49KSh7xq365uB1cR5/8IPX+Cw3hdGbAJc7VMfs=,tag:n4QGT7XdI79w4EqMyrlMew==,type:str]
  secret: ENC[AES256_GCM,data:spBWIccCEEOXjZ0Zf53qLRUxs/6Mzpr3Hn/WZR8t2c6wq7/IZxe9oaL7pqk=,iv:wT/0gnQLmvFoRF+vX9whStwj4eZtciE3VNATiBxb1dU=,tag:B08dqQCbJmP1a0T82VNYZw==,type:str]
  controlPlane:
    endpoint: https://10.1.20.120:6443
  clusterName: main
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
  coreDNS:
    disabled: true
  extraManifests:
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagerconfigs.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagers.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_probes.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheusagents.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheusrules.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_scrapeconfigs.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
    # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.80.1/example/prometheus-operator-crd/monitoring.coreos.com_thanosrulers.yaml
  token: ENC[AES256_GCM,data:4SPvmPxWTVYCBrqbBp4oeNEucUA8Dvw=,iv:xTq9ubYPBQfmIvETdu9NrIQbGup34VE135RubTEuozY=,tag:IcVY1cpcdZqjQ7lREmRM3g==,type:str]
  ca:
    crt: ENC[AES256_GCM,data:EBntuDqvdfQdyIbXykFdeh2aMJTaTQsE4MaF4nl4vQH7x8ImPQ5jwI6v7unHCZp0arRp3Abh1T92jTO0ne+oiamoIYhmaBPn2uMMM9e7bdGFx8yQfou0tTIDiz9gVO7rJNW25q33YhJY9BK6HrVtLa6R6qFkpw/YlFUzTV1K5NQcobqvDeKhDLC2VgJaORungCD6du+Y8BDneMzao6udgs+J9cd0hwUJI1M2KVzINL5yWcRZ9nGz15Jr/p0RVBEST0++lGjqB+7vm0e//LlgCJIsuI9mB/CSJPvOdl8KhECaSKoKPW/LMpua9i+ixq8yFAIfa7AbEdjvG3XD7RLzMVTFs05vS13Oq0kxxq2idRsAqfaM34rep1YbW/nlb7Xdu5enpPI3NUIAz0L/nonrXtnbaoObn1RUS4oVomzrs/oIzUua7abM77m9b+CSIH/Da1m0smCVYro1VINkNMAV4d79nlLdGglZ3uxq9OD8k3oWq8MKxwJRBqNN86hTKkUg+zZsmCqj1AtF0h3iH9wCzXmk7S/dNbowbRapSvUDtA5GsP6DOfi6b/xpg2YOvSp7JRaUr5TKpQY7vDVCTn2nqlvkdXm1J2rdNoOhcVulY9RDDiwlC2NQAe82jXMxflImEqKcgvVP/asjrSddh6Tg8JgSdxaV9zUVDntQ1ysuBLEpokkwhIhfO9f+kEKjwDNBGqRU802cSXwwASdxPPW5BEEay5dhj/yPV03cp2YxbEr+smAvuwOhU83E1Dv2/Kz0uM+4zIjO7463sqSBpVPtIZVktcNoN7R3WnNFE3aSMgHxGNLPBXHVYMjMwXqUDT8qx8OuKYSuwU+L1BgH3hU6B1+dwEn42dlxZl2eadJ8nhftXD/9Oxf2huoy0LCHccX147ueDVodNXHO/LZ1l/9DGYAOymJx+8dC25ti64AVJUtC6iYmptWdKfTgetxKRZ/j0Xdz8dxhF3O3e6cinYvMZdC2j9S/GiYKR+7o0PNFdbzaBFNH+dDis46kxG9CP5EKgxPYPjF0MhAwX+TdsL7yyb3Lw8KRnfsd/MiNEA==,iv:XGWcL+fComK+17lq/seMxcQtnZbkJWP3Jr0PxdBDB/0=,tag:RAdkoE/4P5RRN8RCrwD5zg==,type:str]
    key: ""
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
    - recipient: age1jwm8ccjgfy04r9rwh65rehk72j6rkawkpjnf4rcu4ukwlcfyquhq4p2q23
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLdjVSZDFsR1VBekw5UEYx
        azFGVzRiUW1LSnNRTWJNTW1Qa05DWWNSZ2tJCk9XL0tPSHR1NCtlUExlS0lrQjBR
        ZXVuSlllTTNDQWFiNDU3RDBqdnFQMUEKLS0tIGZSbUR6VDRFZ0dXQndOK0NBSnd0
        RWxxOUgxbGorbDlOWlRXSWhNRXo1UU0KYvt4kD4Y9lvrFkZ6YIzkslAHvu/1SLbP
        9mt+r81DiQCxayzXKqxitlrYOgCB5Evw1twm6ejcmYMsb9N7zoHpTw==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-03-11T19:33:49Z"
  mac: ENC[AES256_GCM,data:66Kt2rEr5NkRyOU/F38fZ+lZqFp8QrrYiHggDXv3FpTycLypw/6W64N6+DvPP9XdrnQZNvoV4zDNjKyHp1fGpSRzbasOUmHVBXo1O6loIc4OU43VsKY1brT+dXofP5ysnok4D2ylZvjfW9aHbA9OPmuVQc9T6qeV2mwJU2GeB9Y=,iv:/H7SqLS2T98DUNM8x0uB96m3Wy0ij+CBdZvSmh6TYR0=,tag:riMdYL0i7n9mCMD0dJBAkQ==,type:str]
  pgp: []
  encrypted_regex: ^(token|crt|key|id|secret|secretboxEncryptionSecret|ca)$
  mac_only_encrypted: true
  version: 3.9.4
