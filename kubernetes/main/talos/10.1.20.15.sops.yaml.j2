version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: vafezn.u0kqzs15a8bh29z6
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJQakNCOGFBREFnRUNBaEExTEtrS2JTc0tweU45ME9wS0EvUHdNQVVHQXl0bGNEQVFNUTR3REFZRFZRUUsKRXdWMFlXeHZjekFlRncweU5EQTNNamt5TURNMk1USmFGdzB6TkRBM01qY3lNRE0yTVRKYU1CQXhEakFNQmdOVgpCQW9UQlhSaGJHOXpNQ293QlFZREsyVndBeUVBaXdzbitFZTA2cUNabGM3TkhNOHdxVGQwYWx1ZWo3cVNuRk5RCmd5RnJUa0NqWVRCZk1BNEdBMVVkRHdFQi93UUVBd0lDaERBZEJnTlZIU1VFRmpBVUJnZ3JCZ0VGQlFjREFRWUkKS3dZQkJRVUhBd0l3RHdZRFZSMFRBUUgvQkFVd0F3RUIvekFkQmdOVkhRNEVGZ1FVbW5yUnVQSTQzRjl0YlZibAowY1d0Mm9DdFRRWXdCUVlESzJWd0EwRUFlaDhiSHFiTWo3cTllWTA5S3ZXK1IvU1JiTzN1TEE5UU1zVTZCTFFiCnhqNGR3c2RxOFFKQkQ0UHpYNmM2ZzgvQWdpcFlhNHB5bDdSdExpbDk2bkZJQVE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  certSANs: ["127.0.0.1", "10.1.20.120"]
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.32.0
    extraArgs:
      rotate-server-certificates: "true"
    extraConfig:
      maxPods: 150
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options: ["bind", "rshared", "rw"]
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.1.20.0/24
    disableManifestsDirectory: true
  network:
    nameservers:
      - 10.1.20.43
      - 10.1.20.1
    hostname: k8s-5
    interfaces:
      - interface: eth0
        dhcp: false
        addresses:
          - 10.1.20.15/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.1.20.1
        mtu: 1500
        vlans:
          - vlanId: 30 # Services Network
            dhcp: false
            addresses:
              - 10.1.30.15/24
            routes:
              - network: 0.0.0.0/0
                gateway: 10.1.30.1
            mtu: 1500
          - vlanId: 40 # Trusted Network
            dhcp: false
            addresses:
              - 10.1.40.15/24
            routes:
              - network: 0.0.0.0/0
                gateway: 10.1.40.1
            mtu: 1500
    disableSearchDomain: true
  time:
    servers:
      - 10.1.20.1
  install:
    disk: /dev/nvme0n1
    extraKernelArgs:
      - net.ifnames=0        # Use eth0 instead of eno1
      - apparmor=0           # Less security, faster puter
      - init_on_alloc=0      # Less security, faster puter
      - init_on_free=0       # Less security, faster puter
      - intel_iommu=on       # PCI Passthrough
      - iommu=pt             # PCI Passthrough
      - mitigations=off      # Less security, faster puter
      - security=none        # Less security, faster puter
    image: factory.talos.dev/installer/6e6f23cd5ca6099bbe4be57a2218f628e61314545d5da36dcc6516c59d3be64f:v1.9.0
  files:
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |
        [plugins]
          [plugins."io.containerd.grpc.v1.cri"]
            enable_unprivileged_ports = true
            enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false

    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 0o644
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
  sysctls:
    fs.inotify.max_user_instances: 8192    # Watchdog
    fs.inotify.max_user_watches: 1048576   # Watchdog
    net.core.rmem_max: 67108864            # Cloudflared / QUIC
    net.core.wmem_max: 67108864            # Cloudflared / QUIC
    net.core.default_qdisc: fq             # 1Gb/s
    net.ipv4.tcp_mtu_probing: 1            # 1Gb/s | Jumbo frames
    net.ipv4.tcp_congestion_control: bbr
    net.ipv4.tcp_window_scaling: 1         # 1Gb/s
    vm.nr_hugepages: 1024                  # postgresql
  # sysfs:
  #   devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
  #   devices.system.cpu.cpu0.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu1.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu2.cpufreq.energy_performance_preference: balance_performance
  #   devices.system.cpu.cpu3.cpufreq.energy_performance_preference: balance_performance
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      resolveMemberNames: true
      forwardKubeDNSToHost: false # Incompatible with Cilium bpf masquerade
  udev:
    rules:
      # Thunderbolt
      - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"
      # Coral Edge M.2 TPU
      - SUBSYSTEM=="apex", KERNEL=="apex*", GROUP="44", MODE="0660"
       # Intel GPU
      - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
  nodeLabels:
    topology.kubernetes.io/region: main
    topology.kubernetes.io/zone: w
cluster:
  id: cqtklx71AK2tF3_KgELXPJsszoQ8ZNrqXqj88sxTLhw=
  secret: SRpsXhS7f4mp9WKf6T8jhTdnoYOkD7jrmnA4RmIMYXs=
  controlPlane:
    endpoint: https://10.1.20.120:6443
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
  coreDNS:
    disabled: true
  token: q2dxad.mh582h8fvxh8qemh
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJpRENDQVMrZ0F3SUJBZ0lRTityV0UycXZpc1RKcFBpaElaakJhakFLQmdncWhrak9QUVFEQWpBVk1STXcKRVFZRFZRUUtFd3ByZFdKbGNtNWxkR1Z6TUI0WERUSTBNRGN5T1RJd016WXhNVm9YRFRNME1EY3lOekl3TXpZeApNVm93RlRFVE1CRUdBMVVFQ2hNS2EzVmlaWEp1WlhSbGN6QlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VICkEwSUFCTldycWpTTjZna0dWYTRTWE53WkZOWm5QU3Eya2JtTlpQUVdSSWFMY1VjbmNRN1RDUXE4eUhBV2VzTDEKN2puWE5mV1YwZWR0U05EakluL3U2U3V0VWM2allUQmZNQTRHQTFVZER3RUIvd1FFQXdJQ2hEQWRCZ05WSFNVRQpGakFVQmdnckJnRUZCUWNEQVFZSUt3WUJCUVVIQXdJd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFCkZnUVU3SHA2NFNGNUdGOWNhcHR5b3Blc042Z1JSWUF3Q2dZSUtvWkl6ajBFQXdJRFJ3QXdSQUlnRXZWWWh3cUUKOHdhSDVhT2FzbEt2SkNRRkNBUld2M2tnMUVSMUM1V3llVllDSUM1SFFIZzRHSlQ5Y2UvN2NsWmNEdTE0VnlTeApDN1ZqUytGaVlCUDFYNHlwCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    key: ""
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: true
